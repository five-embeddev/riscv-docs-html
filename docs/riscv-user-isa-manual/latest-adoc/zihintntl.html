<html>
<head>
<link rel="stylesheet" href="../../assets/docs.css">
<title>RISC-V Instruction Set Manual, Volume I: RISC-V User-Level ISA</title>
</head>
<body>

<table>
<tr><th colspan=2>Metadata Table</th></tr>
<tr><th>Manual Type</th><td> user</td></tr>
<tr><th>Spec Revision</th><td> </td></tr>
<tr><th>Spec Release Date</th><td> </td></tr>
<tr><th>Git Revision</th><td> riscv-isa-release-1239329-2023-05-23-96-g1ee25e1</td></tr>
<tr><th>Git URL</th><td><a href=https://github.com/riscv/riscv-isa-manual.git>https://github.com/riscv/riscv-isa-manual.git</a></td></tr>
<tr><th>Source</th><td>src/zihintntl.adoc</td></tr>
<tr><th>Conversion Date</th><td>2023/11/12</td></tr>
<tr><th>License</th><td><a href=https://creativecommons.org/licenses/by/4.0/>CC-by-4.0</a></td></tr>
</table>

<div class="sect1">
<h2 id="chap:zihintntl">1. "Zihintntl" Non-Temporal Locality Hints, Version 1.0</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The NTL instructions are HINTs that indicate that the explicit memory
accesses of the immediately subsequent instruction (henceforth "target
instruction") exhibit poor temporal locality of reference. The NTL
instructions do not change architectural state, nor do they alter the
architecturally visible effects of the target instruction. Four variants
are provided:</p>
</div>
<div class="paragraph">
<p>The NTL.P1 instruction indicates that the target instruction does not
exhibit temporal locality within the capacity of the innermost level of
private cache in the memory hierarchy. NTL.P1 is encoded as
ADD <em>x0, x0, x2</em>.</p>
</div>
<div class="paragraph">
<p>The NTL.PALL instruction indicates that the target instruction does not
exhibit temporal locality within the capacity of any level of private
cache in the memory hierarchy. NTL.PALL is encoded as ADD <em>x0, x0, x3</em>.</p>
</div>
<div class="paragraph">
<p>The NTL.S1 instruction indicates that the target instruction does not
exhibit temporal locality within the capacity of the innermost level of
shared cache in the memory hierarchy. NTL.S1 is encoded as
ADD <em>x0, x0, x4</em>.</p>
</div>
<div class="paragraph">
<p>The NTL.ALL instruction indicates that the target instruction does not
exhibit temporal locality within the capacity of any level of cache in
the memory hierarchy. NTL.ALL is encoded as ADD <em>x0, x0, x5</em>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The NTL instructions can be used to avoid cache pollution when streaming
data or traversing large data structures, or to reduce latency in
producer-consumer interactions.</p>
</div>
<div class="paragraph">
<p>A microarchitecture might use the NTL instructions to inform the cache
replacement policy, or to decide which cache to allocate into, or to
avoid cache allocation altogether. For example, NTL.P1 might indicate
that an implementation should not allocate a line in a private L1 cache,
but should allocate in L2 (whether private or shared). In another
implementation, NTL.P1 might allocate the line in L1, but in the
least-recently used state.</p>
</div>
<div class="paragraph">
<p>NTL.ALL will typically inform implementations not to allocate anywhere
in the cache hierarchy. Programmers should use NTL.ALL for accesses that
have no exploitable temporal locality.</p>
</div>
<div class="paragraph">
<p>Like any HINTs, these instructions may be freely ignored. Hence,
although they are described in terms of cache-based memory hierarchies,
they do not mandate the provision of caches.</p>
</div>
<div class="paragraph">
<p>Some implementations might respect these HINTs for some memory accesses
but not others: e.g., implementations that implement LR/SC by acquiring
a cache line in the exclusive state in L1 might ignore NTL instructions
on LR and SC, but might respect NTL instructions for AMOs and regular
loads and stores.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><a href="#ntl-portable">Table 1</a> lists several software use cases and the recommended NTL variant that <em>portable</em> software—i.e., software not tuned for any specific implementation&#8217;s memory hierarchy—should use in each case.</p>
</div>
<table id="ntl-portable" class="tableblock frame-all grid-all fit-content center">
<caption class="title">Table 1. Recommended NTL variant for portable software to employ in various scenarios.</caption>
<colgroup>
<col>
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Scenario</th>
<th class="tableblock halign-left valign-top">Recommended NTL variant</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Access to a working set between and in size</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">NTL.P1</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Access to a working set between and in size</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">NTL.PALL</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Access to a working set greater than in size</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">NTL.S1</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Access with no exploitable temporal locality (e.g., streaming)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">NTL.ALL</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Access to a contended synchronization variable</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">NTL.PALL</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The working-set sizes listed in <a href="#ntl-portable">Table 1</a> are not meant to
constrain implementers' cache-sizing decisions.
Cache sizes will obviously vary between implementations, and so software
writers should only take these working-set sizes as rough guidelines.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><a href="#ntl">Table 2</a> lists several sample memory hierarchies and
recommends how each NTL variant maps onto each cache level. The table
also recommends which NTL variant that implementation-tuned software
should use to avoid allocating in a particular cache level. For example,
for a system with a private L1 and a shared L2, it is recommended that
NTL.P1 and NTL.PALL indicate that temporal locality cannot be exploited
by the L1, and that NTL.S1 and NTL.ALL indicate that temporal locality
cannot be exploited by the L2. Furthermore, software tuned for such a
system should use NTL.P1 to indicate a lack of temporal locality
exploitable by the L1, or should use NTL.ALL indicate a lack of temporal
locality exploitable by the L2.</p>
</div>
<div class="paragraph">
<p>If the C extension is provided, compressed variants of these HINTs are
also provided: C.NTL.P1 is encoded as C.ADD <em>x0, x2</em>; C.NTL.PALL is
encoded as C.ADD <em>x0, x3</em>; C.NTL.S1 is encoded as C.ADD <em>x0, x4</em>; and
C.NTL.ALL is encoded as C.ADD <em>x0, x5</em>.</p>
</div>
<div class="paragraph">
<p>The NTL instructions affect all memory-access instructions except the
cache-management instructions in the Zicbom extension.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>As of this writing, there are no other exceptions to this rule, and so
the NTL instructions affect all memory-access instructions defined in
the base ISAs and the A, F, D, Q, C, and V standard extensions, as well
as those defined within the hypervisor extension in Volume II.</p>
</div>
<div class="paragraph">
<p>The NTL instructions can affect cache-management operations other than
those in the Zicbom extension. For example, NTL.PALL followed by
CBO.ZERO might indicate that the line should be allocated in L3 and
zeroed, but not allocated in L1 or L2.</p>
</div>
</td>
</tr>
</table>
</div>
<div style="page-break-after: always;"></div>
<table id="ntl" class="tableblock frame-all grid-all fit-content center">
<caption class="title">Table 2. Mapping of NTL variants to various memory hierarchies.</caption>
<colgroup>
<col>
<col>
<col>
<col>
<col>
<col>
<col>
<col>
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Memory hierarchy</th>
<th class="tableblock halign-center valign-top" colspan="4">Recommended mapping of NTL<br>
variant to actual cache level</th>
<th class="tableblock halign-center valign-top" colspan="4">Recommended NTL variant for<br>
explicit cache management</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">P1</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">PALL</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">S1</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">ALL</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">L1</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">L2</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">L3</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">L4/L5</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top" colspan="9"><p class="tableblock">Common Scenarios</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">No caches</p></td>
<td class="tableblock halign-center valign-top" colspan="4"><p class="tableblock">---</p></td>
<td class="tableblock halign-center valign-top" colspan="4"><p class="tableblock">none</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Private L1 only</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">L1</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">L1</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">L1</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">L1</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">ALL</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">---</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">---</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">---</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Private L1; shared L2</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">L1</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">L1</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">L2</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">L2</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">P1</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">ALL</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">---</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">---</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Private L1; shared L2/L3</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">L1</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">L1</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">L2</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">L3</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">P1</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">S1</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">ALL</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">---</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Private L1/L2</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">L1</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">L2</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">L2</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">L2</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">P1</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">ALL</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">---</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">---</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Private L1/L2; shared L3</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">L1</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">L2</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">L3</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">L3</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">P1</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">PALL</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">ALL</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">---</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Private L1/L2; shared L3/L4</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">L1</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">L2</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">L3</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">L4</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">P1</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">PALL</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">S1</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">ALL</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top" colspan="9"><p class="tableblock">Uncommon Scenarios</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Private L1/L2/L3; shared L4</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">L1</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">L3</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">L4</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">L4</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">P1</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">P1</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">PALL</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">ALL</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Private L1; shared L2/L3/L4</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">L1</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">L1</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">L2</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">L4</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">P1</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">S1</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">ALL</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">ALL</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Private L1/L2; shared L3/L4/L5</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">L1</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">L2</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">L3</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">L5</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">P1</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">PALL</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">S1</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">ALL</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Private L1/L2/L3; shared L4/L5</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">L1</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">L3</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">L4</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">L5</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">P1</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">P1</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">PALL</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">ALL</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>When an NTL instruction is applied to a prefetch hint in the Zicbop
extension, it indicates that a cache line should be prefetched into a
cache that is <em>outer</em> from the level specified by the NTL.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>For example, in a system with a private L1 and shared L2, NTL.P1
followed by PREFETCH.R might prefetch into L2 with read intent.</p>
</div>
<div class="paragraph">
<p>To prefetch into the innermost level of cache, do not prefix the
prefetch instruction with an NTL instruction.</p>
</div>
<div class="paragraph">
<p>In some systems, NTL.ALL followed by a prefetch instruction might
prefetch into a cache or prefetch buffer internal to a memory
controller.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Software is discouraged from following an NTL instruction with an
instruction that does not explicitly access memory. Nonadherence to this
recommendation might reduce performance but otherwise has no
architecturally visible effect.</p>
</div>
<div class="paragraph">
<p>In the event that a trap is taken on the target instruction,
implementations are discouraged from applying the NTL to the first
instruction in the trap handler. Instead, implementations are
recommended to ignore the HINT in this case.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If an interrupt occurs between the execution of an NTL instruction and
its target instruction, execution will normally resume at the target
instruction. That the NTL instruction is not reexecuted does not change
the semantics of the program.</p>
</div>
<div class="paragraph">
<p>Some implementations might prefer not to process the NTL instruction
until the target instruction is seen (e.g., so that the NTL can be fused
with the memory access it modifies). Such implementations might
preferentially take the interrupt before the NTL, rather than between
the NTL and the memory access.</p>
</div>
</td>
</tr>
</table>
</div>
<hr>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Since the NTL instructions are encoded as ADDs, they can be used within
LR/SC loops without voiding the forward-progress guarantee. But, since
using other loads and stores within an LR/SC loop <em>does</em> void the
forward-progress guarantee, the only reason to use an NTL within such a
loop is to modify the LR or the SC.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>

</body>
</html>